#!/usr/bin/env bash

set -ueo pipefail

DOTFILES_PATH="$HOME/.dotfiles"

while read line; do
	cmd=$(echo "$line" | awk -F"\t+" '{print $1}')
	src=$(echo "$line" | awk -F"\t+" '{print $2}')
	dest=$(echo "$line" | awk -F"\t+" '{print $3}')

	if [ -n "$dest" ]; then
		if [[ "$dest" =~ /$ ]] ; then
			mkdir -p "$HOME/$dest";
		else 
			mkdir -p $(dirname "$HOME/$dest");
		fi
	else
		dest=.$(basename "$src")
	fi
	
	case $cmd in
		ln|symlink)
			ln -sfv "$DOTFILES_PATH/"$src "$HOME/$dest"
		;;
	esac
done < <(grep -vE -e "^\s*#" -e "^\s*$" "$DOTFILES_PATH/install")

(
	cd "$DOTFILES_PATH"
	npm install
	pip install -r requirements.txt --user --install-option="--install-scripts=$HOME/bin"
)

if [ -f "$HOME/bin/composer" ]; then
	"$HOME/bin/composer" self-update
else
	(
		cd $HOME/bin
		curl -s http://getcomposer.org/installer | php -- --filename="composer"
		chmod a+x composer
	)
fi

composer global install

